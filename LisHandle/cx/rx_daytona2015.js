data=`H|\^&|||Analyzer|||||||||20211224155431
P|1|2608||||||U|||||||0||||||||||^^^|
C|1|I||G
O|1|2608||^^^06|||20211222000000||0|||||||02
C|1|I||G
R|1|^^^06|69.62|g/l||N||||||20211222163659      
P|2|2608||||||U|||||||0||||||||||^^^|
C|1|I||G
O|1|2608||^^^09|||20211222000000||0|||||||02
C|1|I||G
R|1|^^^09|11.48|mmol/l||N||||||20211222163712      
P|3|anhlocbh||||||U|||||||0||||||||||^^^|
C|1|I||G
O|1|anhlocbh||^^^01|||20211223000000||0|||||||02
C|1|I||G
R|1|^^^01|65.96|U/L||N||||||20211223085025      
P|4|anhlocbh||||||U|||||||0||||||||||^^^|
C|1|I||G
O|1|anhlocbh||^^^02|||20211223000000||0|||||||02
C|1|I||G
R|1|^^^02|47.28|U/L||N||||||20211223085051      
P|5|anhlocbh||||||U|||||||0||||||||||^^^|
C|1|I||G
O|1|anhlocbh||^^^03|||20211223000000||0|||||||02
C|1|I||G
R|1|^^^03|4.51|mmol/l||N||||||20211223085105      
P|6|anhlocbh||||||U|||||||0||||||||||^^^|
C|1|I||G
O|1|anhlocbh||^^^04|||20211223000000||0|||||||02
C|1|I||G
R|1|^^^04|117.20|umol/l||N||||||20211223084838      
P|7|anhlocbh||||||U|||||||0||||||||||^^^|
C|1|I||G
O|1|anhlocbh||^^^05|||20211223000000||0|||||||02
C|1|I||G
R|1|^^^05|18.63|mmol/l||N||||||20211223085132      
P|8|anhlocbh||||||U|||||||0||||||||||^^^|
C|1|I||G
O|1|anhlocbh||^^^07|||20211223000000||0|||||||02
C|1|I||G
R|1|^^^07|9.13|mmol/l||N||||||20211223085145      
P|9|anhlocbh||||||U|||||||0||||||||||^^^|
C|1|I||G
O|1|anhlocbh||^^^08|||20211223000000||0|||||||02
C|1|I||G
R|1|^^^08|362.12|umol/L||N||||||20211223084918      
P|10|anhlocbh||||||U|||||||0||||||||||^^^|
C|1|I||G
O|1|anhlocbh||^^^09|||20211223000000||0|||||||02
C|1|I||G
R|1|^^^09|10.05|mmol/l||N||||||20211223085212      
P|11|anhlocbh||||||U|||||||0||||||||||^^^|
C|1|I||G
O|1|anhlocbh||^^^14|||20211223000000||0|||||||02
C|1|I||G
R|1|^^^14|50|U/L||A||||||20211223085225      
P|12|2683||||||U|||||||0||||||||||^^^|
C|1|I||G
O|1|2683||^^^01|||20211223000000||0|||||||02
C|1|I||G
R|1|^^^01|120.81|U/L||N||||||20211223144710      
P|13|2683||||||U|||||||0||||||||||^^^|
C|1|I||G
O|1|2683||^^^02|||20211223000000||0|||||||02
C|1|I||G
R|1|^^^02|71.05|U/L||A||||||20211223144723      
P|14|2684||||||U|||||||0||||||||||^^^|
C|1|I||G
O|1|2684||^^^01|||20211223000000||0|||||||02
C|1|I||G
R|1|^^^01|27.49|U/L||N||||||20211223144643      
P|15|2684||||||U|||||||0||||||||||^^^|
C|1|I||G
O|1|2684||^^^02|||20211223000000||0|||||||02
C|1|I||G
R|1|^^^02|26.52|U/L||A||||||20211223144656      
P|16|1032||||||U|||||||0||||||||||^^^|
C|1|I||G
O|1|1032||^^^05|||20211223000000||0|||||||02
C|1|I||G
R|1|^^^05|7.21|mmol/l||N||||||20211223160319      
P|17|1032||||||U|||||||0||||||||||^^^|
C|1|I||G
O|1|1032||^^^06|||20211223000000||0|||||||02
C|1|I||G
R|1|^^^06|26.57|g/l||N||||||20211223160332      
P|18|2686||||||U|||||||0||||||||||^^^|
C|1|I||G
O|1|2686||^^^01|||20211223000000||0|||||||02
C|1|I||G
R|1|^^^01|18.00|U/L||N||||||20211223163129      
P|19|2686||||||U|||||||0||||||||||^^^|
C|1|I||G
O|1|2686||^^^02|||20211223000000||0|||||||02
C|1|I||G
R|1|^^^02|31.12|U/L||A||||||20211223163143      
P|20|2686||||||U|||||||0||||||||||^^^|
C|1|I||G
O|1|2686||^^^03|||20211223000000||0|||||||02
C|1|I||G
R|1|^^^03|4.21|mmol/l||N||||||20211223163156      
P|21|2686||||||U|||||||0||||||||||^^^|
C|1|I||G
O|1|2686||^^^04|||20211223000000||0|||||||02
C|1|I||G
R|1|^^^04|96.68|umol/l||N||||||20211223162930      
P|22|2686||||||U|||||||0||||||||||^^^|
C|1|I||G
O|1|2686||^^^05|||20211223000000||0|||||||02
C|1|I||G
R|1|^^^05|5.69|mmol/l||N||||||20211223163223      
P|23|2686||||||U|||||||0||||||||||^^^|
C|1|I||G
O|1|2686||^^^07|||20211223000000||0|||||||02
C|1|I||G
R|1|^^^07|0.92|mmol/l||N||||||20211223163236      
P|24|2686||||||U|||||||0||||||||||^^^|
C|1|I||G
O|1|2686||^^^09|||20211223000000||0|||||||02
C|1|I||G
R|1|^^^09|7.21|mmol/l||N||||||20211223163250      
P|25|linh||||||U|||||||0||||||||||^^^|
C|1|I||G
O|1|linh||^^^01|||20211223000000||0|||||||02
C|1|I||G
R|1|^^^01|14.82|U/L||N||||||20211223162929      
P|26|linh||||||U|||||||0||||||||||^^^|
C|1|I||G
O|1|linh||^^^02|||20211223000000||0|||||||02
C|1|I||G
R|1|^^^02|21.56|U/L||A||||||20211223162943  `

var Obketquamay = [];
var dsketqua   = [];
var mydata = data;

var ds_chiso = new Object()
ds_chiso['01'] = 'AST'
ds_chiso['02'] = 'ALT'
ds_chiso['03'] = 'GLUCPA'
ds_chiso['04'] = 'CHOL'
ds_chiso['05'] = 'TRIGS'
ds_chiso['06'] = 'CREAT'
ds_chiso['07'] = 'UREA'
ds_chiso['08'] = 'UA'
ds_chiso['09'] = 'TP'
ds_chiso['10'] = 'DBIL'
ds_chiso['11'] = 'TBIL'
ds_chiso['12'] = 'AMY'
ds_chiso['13'] = 'CAL1S'
ds_chiso['14'] = '14'
ds_chiso['15'] = 'ALB'
ds_chiso['16'] = 'HDL'
ds_chiso['17'] = 'LDL'
ds_chiso['18'] = 'EtOH'
ds_chiso['19'] = 'HBA1C'
ds_chiso['20'] = 'hb'

//var mydata = data.replace(/^\s*[\r\n]/gm, '');

function chuanhoa_barcode(tmp_stt){
    tmp_stt = tmp_stt.replace(/^0+/,'') // remove leading zero
    var barcode = '0000';
    var stt = barcode.substring(0, barcode.length - tmp_stt.length) + tmp_stt;
    return stt
}


if(mydata.indexOf("\n")!=-1)
{
    var rows = mydata.split("\n");
}else  {var rows = mydata.split("\r"); }


var list_maxn = []
var item_ketqua = null;
for(i=0; i< rows.length; i++){
    var currentRow = rows[i]
    if(currentRow.startsWith('O|')){
        item_ketqua = new Object();
        item_ketqua.stt = chuanhoa_barcode(currentRow.split('|')[2].trim());        
    }
    if(currentRow.startsWith('R|') && item_ketqua != null){
        var ma_xn_key = currentRow.split('|')[2].replace(/\^/g,'')
        if(list_maxn.indexOf(item_ketqua.stt + ma_xn_key)==-1){
            item_ketqua.ma_xn_may = ds_chiso[ma_xn_key]
            item_ketqua.ketqua = currentRow.split('|')[3]
            dsketqua.push(item_ketqua);
            list_maxn.push(item_ketqua.stt + ma_xn_key)
            item_ketqua = null // unreference to avoid duplicate
        }
    }
}


return dsketqua;