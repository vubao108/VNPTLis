data=`|||^^^|
C|1|I||G
O|1|0791||^^^05|||20211210000000||0|||||||02
C|1|I||G
R|1|^^^05|0.58|mmol/l||N||||||20211210092646      
P|4|1791||||||U|||||||0||||||||||^^^|
C|1|I||G
O|1|1791||^^^09|||20211210000000||0|||||||02
C|1|I||G
R|1|^^^09|75.91|g/l||N||||||20211210092700      
P|5|795||||||U|||||||0||||||||||^^^|
C|1|I||G
O|1|795||^^^03|||20211210000000||0|||||||02
C|1|I||G
R|1|^^^03|9.20|mmol/l||H||||||20211210092713      
P|6|1795||||||U|||||||0||||||||||^^^|
C|1|I||G
O|1|1795||^^^04|||20211210000000||0|||||||02
C|1|I||G
R|1|^^^04|7.42|mmol/l||H||||||20211210092726      
P|7|1795||||||U|||||||0||||||||||^^^|
C|1|I||G
O|1|1795||^^^05|||20211210000000||0|||||||02
C|1|I||G
R|1|^^^05|3.25|mmol/l||H||||||20211210092740      
P|8|1795||||||U|||||||0||||||||||^^^|
C|1|I||G
O|1|1795||^^^09|||20211210000000||0|||||||02
C|1|I||G
R|1|^^^09|82.00|g/l||H||||||20211210092753      
P|9|1798||||||U|||||||0||||||||||^^^|
C|1|I||G
O|1|1798||^^^03|||20211210000000||0|||||||02
C|1|I||G
R|1|^^^03|6.45|mmol/l||H||||||20211210092806      
P|10|1798||||||U|||||||0||||||||||^^^|
C|1|I||G
O|1|1798||^^^04|||20211210000000||0|||||||02
C|1|I||G
R|1|^^^04|5.64|mmol/l||H||||||20211210092820      
P|11|1798||||||U|||||||0||||||||||^^^|
C|1|I||G
O|1|1798||^^^05|||20211210000000||0|||||||02
C|1|I||G
R|1|^^^05|1.53|mmol/l||N||||||20211210092833      
P|12|1798||||||U|||||||0||||||||||^^^|
C|1|I||G
O|1|1798||^^^09|||20211210000000||0|||||||02
C|1|I||G
R|1|^^^09|73.62|g/l||N||||||20211210092846      
P|13|1799||||||U|||||||0||||||||||^^^|
C|1|I||G
O|1|1799||^^^03|||20211210000000||0|||||||02
C|1|I||G
R|1|^^^03|6.96|mmol/l||H||||||20211210092900      
P|14|1799||||||U|||||||0||||||||||^^^|
C|1|I||G
O|1|1799||^^^04|||20211210000000||0|||||||02
C|1|I||G
R|1|^^^04|2.54|mmol/l||L||||||20211210092913      
P|15|1799||||||U|||||||0||||||||||^^^|
C|1|I||G
O|1|1799||^^^05|||20211210000000||0|||||||02
C|1|I||G
R|1|^^^05|0.37|mmol/l||L||||||20211210092927      
P|16|1799||||||U|||||||0||||||||||^^^|
C|1|I||G
O|1|1799||^^^09|||20211210000000||0|||||||02
C|1|I||G
R|1|^^^09|74.91|g/l||N||||||20211210092940      
P|17|1800||||||U|||||||0||||||||||^^^|
C|1|I||G
O|1|1800||^^^03|||20211210000000||0|||||||02
C|1|I||G
R|1|^^^03|8.27|mmol/l||H||||||20211210092953      
P|18|1800||||||U|||||||0||||||||||^^^|
C|1|I||G
O|1|1800||^^^04|||20211210000000||0|||||||02
C|1|I||G
R|1|^^^04|5.22|mmol/l||H||||||20211210093007      
P|19|1800||||||U|||||||0||||||||||^^^|
C|1|I||G
O|1|1800||^^^05|||20211210000000||0|||||||02
C|1|I||G
R|1|^^^05|1.53|mmol/l||N||||||20211210093020      
P|20|1800||||||U|||||||0||||||||||^^^|
C|1|I||G
O|1|1800||^^^09|||20211210000000||0|||||||02
C|1|I||G
R|1|^^^09|72.59|g/l||N||||||20211210093033      
P|21|1809||||||U|||||||0||||||||||^^^|
C|1|I||G
O|1|1809||^^^03|||20211210000000||0|||||||02
C|1|I||G
R|1|^^^03|11.13|mmol/l||H||||||20211210092526      
P|22|1809||||||U|||||||0||||||||||^^^|
C|1|I||G
O|1|1809||^^^04|||20211210000000||0|||||||02
C|1|I||G
R|1|^^^04|5.66|mmol/l||H||||||20211210092540      
P|23|1809||||||U|||||||0||||||||||^^^|
C|1|I||G
O|1|1809||^^^05|||20211210000000||0|||||||02
C|1|I||G
R|1|^^^05|3.51|mmol/l||H||||||20211210092553      
P|24|1809||||||U|||||||0||||||||||^^^|
C|1|I||G
O|1|1809||^^^09|||20211210000000||0|||||||02
C|1|I||G
R|1|^^^09|80.12|g/l||N||||||20211210092606      
P|25|1810||||||U|||||||0||||||||||^^^|
C|1|I||G
O|1|1810||^^^03|||20211210000000||0|||||||02
C|1|I||G
R|1|^^^03|6.43|mmol/l||H||||||20211210093047      
P|26|1810||||||U|||||||0||||||||||^^^|
C|1|I||G
O|1|1810||^^^04|||20211210000000||0|||||||02
C|1|I||G
R|1|^^^04|5.77|mmol/l||H||||||20211210093100      
P|27|1810||||||U|||||||0||||||||||^^^|
C|1|I||G
O|1|1810||^^^05|||20211210000000||0|||||||02
C|1|I||G
R|1|^^^05|1.78|mmol/l||N||||||20211210093113      
P|28|1789||||||U|||||||0||||||||||^^^|
C|1|I||G
O|1|1789||^^^12|||20211210000000||0|||||||02
C|1|I||G
R|1|^^^12|84|U/L||H||||||20211210101219      
P|29|1802||||||U|||||||0||||||||||^^^|
C
`

var Obketquamay = [];
var dsketqua   = [];
var mydata = data;

var ds_chiso = new Map()
ds_chiso['01'] = 'AST'
ds_chiso['02'] = 'ALT'
ds_chiso['03'] = 'GLUCPA'
ds_chiso['04'] = 'CHOL'
ds_chiso['05'] = 'TRIGS'
ds_chiso['06'] = 'CREAT'
ds_chiso['07'] = 'UREA'
ds_chiso['08'] = 'UA'
ds_chiso['09'] = 'TP'
ds_chiso['10'] = 'DBIL'
ds_chiso['11'] = 'TBIL'
ds_chiso['12'] = 'AMY'
ds_chiso['13'] = 'CAL1S'
ds_chiso['15'] = 'ALB'
ds_chiso['16'] = 'HDL'
ds_chiso['17'] = 'LDL'
ds_chiso['18'] = 'EtOH'
ds_chiso['19'] = 'HBA1C'
ds_chiso['20'] = 'hb'

//var mydata = data.replace(/^\s*[\r\n]/gm, '');

function chuanhoa_barcode(tmp_stt){
    tmp_stt = tmp_stt.replace(/^0+/,'') // remove leading zero
    var barcode = '0000';
    var stt = barcode.substring(0, barcode.length - tmp_stt.length) + tmp_stt;
    return stt
}


if(mydata.indexOf("\r")!=-1)
{
    var rows = mydata.split("\r");
}else  {var rows = mydata.split("\n"); }


var item_ketqua = null;
for(i=0; i< rows.length; i++){
    var currentRow = rows[i]
    if(currentRow.startsWith('O|')){
        item_ketqua = new Object();
        item_ketqua.stt = chuanhoa_barcode(currentRow.split('|')[2].trim());        
    }
    if(currentRow.startsWith('R|') && item_ketqua != null){
        var ma_xn_key = currentRow.split('|')[2].replace(/\^/g,'')
        item_ketqua.ma_xn_may = ds_chiso[ma_xn_key]
        item_ketqua.ketqua = currentRow.split('|')[3]
        dsketqua.push(item_ketqua);
        item_ketqua = null // unreference to avoid duplicate
    }
}


return dsketqua;